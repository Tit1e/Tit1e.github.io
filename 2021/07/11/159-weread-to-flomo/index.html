<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>微信读书笔记导入 flomo · Tit1e</title><meta name="description" content="微信读书笔记导入 flomo - Tit1e"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://github.com/Tit1e/atom.xml" title="Tit1e"></head><body><div class="wrap"><header><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span><span id="busuanzi_container_site_uv">本站访客数<span id="busuanzi_value_site_uv"></span>人次</span><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">主页</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">过往</a></li><li class="nav-list-item"><a href="https://album.animalcrossing.life" target="_blank" class="nav-list-link">摄影集</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">订阅</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">微信读书笔记导入 flomo</h1><div class="post-info">Jul 11, 2021</div><div class="post-content"><p>Kindle to Flomo 现在已经支持微信读书笔记的导入啦。我现在想着要不要给它换个名字，因为它现在已经支持 Kindle、Apple Books、微信读书三种导入方式了。这个后面再说吧。</p>
<p>远离其实就是访问微信读书网页版，然后扫码登录，获取到 cookie，之后就模拟请求腾讯那边的接口就可以了。因为要获取cookie，模拟请求，所以这个功能在纯浏览器端肯定是无法实现的，因为存在跨域等限制。但我这个应用还有 electron 版本，有客户端就好办很多。</p>
<p>经过一番查询，找到 electron 捕获应用内所有请求，iframe 中的请求当然也包含在内：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 下面两种引入方式只需选择一种就行，看在什么进程中使用</span></span><br><span class="line"><span class="comment">// 主进程</span></span><br><span class="line"><span class="keyword">const</span> &#123; session &#125; = <span class="built_in">require</span>(<span class="string">'electron'</span>)</span><br><span class="line"><span class="comment">// 渲染进程</span></span><br><span class="line"><span class="keyword">const</span> &#123; session &#125; = <span class="built_in">require</span>(<span class="string">'electron'</span>).remote</span><br><span class="line"></span><br><span class="line"><span class="comment">// 过滤器，只捕获此域名下的请求</span></span><br><span class="line"><span class="keyword">const</span> filter = &#123;</span><br><span class="line">  urls: [<span class="string">'https://weread.qq.com/*'</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">session.defaultSession.webRequest.onBeforeSendHeaders(filter,(details, callback) =&gt; &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(details.requestHeaders.Cookie)</span><br><span class="line">  callback(details)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>相关接口：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取某本书你的全部笔记</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> get_bookmarklist = <span class="function"><span class="params">bookId</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> axios(&#123;</span><br><span class="line">    method: <span class="string">'get'</span>,</span><br><span class="line">    url: <span class="string">'/book/bookmarklist'</span>,</span><br><span class="line">    headers,</span><br><span class="line">    params: &#123;</span><br><span class="line">      bookId</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 获取某一本书的热门划线</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> get_bestbookmarks = <span class="function"><span class="params">bookId</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> axios(&#123;</span><br><span class="line">    method: <span class="string">'get'</span>,</span><br><span class="line">    url: <span class="string">'/book/bestbookmarks'</span>,</span><br><span class="line">    headers,</span><br><span class="line">    params: &#123;</span><br><span class="line">      bookId</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 获取书架上的书籍列表</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> get_bookshelf = <span class="function">(<span class="params">cookie</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> axios(&#123;</span><br><span class="line">    method: <span class="string">'get'</span>,</span><br><span class="line">    url: <span class="string">'/shelf/friendCommon'</span>,</span><br><span class="line">    headers,</span><br><span class="line">    params: &#123;</span><br><span class="line">      userVid: getUid(cookie)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 获取你的所有有笔记本书单</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> get_notebooklist = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> axios(&#123;</span><br><span class="line">    method: <span class="string">'get'</span>,</span><br><span class="line">    headers,</span><br><span class="line">    url: <span class="string">'/user/notebooks'</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 获取某本书的详情</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> get_bookinfo = <span class="function"><span class="params">bookId</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> axios(&#123;</span><br><span class="line">    method: <span class="string">'get'</span>,</span><br><span class="line">    url: <span class="string">'/book/info'</span>,</span><br><span class="line">    headers,</span><br><span class="line">    params: &#123;</span><br><span class="line">      bookId</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取某本书的批注</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> get_reviewlist = <span class="function">(<span class="params">params, cookie</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> axios(&#123;</span><br><span class="line">    method: <span class="string">'get'</span>,</span><br><span class="line">    url: <span class="string">'/web/review/list'</span>,</span><br><span class="line">    baseURL: <span class="string">'https://weread.qq.com'</span>,</span><br><span class="line">    headers,</span><br><span class="line">    params: &#123;</span><br><span class="line">      userVid: getUid(cookie),</span><br><span class="line">      ...params</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要的逻辑其实就是：</p>
<ol>
<li>用户点击导入按钮</li>
<li>通过 iframe 访问 <a href="https://weread.qq.com/#login" target="_blank" rel="noopener">https://weread.qq.com/#login</a></li>
<li>获取 cookie，请求图书列表</li>
<li>如果用户为登录，那么请求就会失败，此时显示 iframe 内容，iframe 中应该有个登录二维码</li>
<li>用户扫码登录，重新请求接口，进行后续请求</li>
</ol>
<p><a href="https://github.com/Tit1e/kindle2Flomo">查看仓库</a></p>
<p>参考：</p>
<p><a href="https://github.com/yixin-zzz/wr_marker">wr_marker</a></p>
<p><a href="https://github.com/arry-lee/wereader">wereader</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2021/05/30/158-mac-handle-bad-app/" class="next">下一篇</a></div><div class="copyright"><p>© 2016 - 2021 <a href="https://github.com/Tit1e" target="_blank">Tit1e</a>, powered by <a href="https://github.com/Tit1e/hexo-theme-simple" target="_blank">hexo-theme-simple</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>