<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>Node.js 爬虫初步实践 · Tit1e</title><meta name="description" content="Node.js 爬虫初步实践 - Tit1e"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://github.com/Tit1e/atom.xml" title="Tit1e"></head><body><div class="wrap"><header><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">主页</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">过往</a></li><li class="nav-list-item"><a href="https://album.animalcrossing.life" target="_blank" class="nav-list-link">摄影集</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">订阅</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Node.js 爬虫初步实践</h1><div class="post-info">Dec 28, 2020</div><div class="post-content"><p>今年年初的时候动森因为本身的影响力加上疫情的原因，在全球大火，很多原本都不知道 Switch 是什么的人，都因为动森入了Switch，当时 Switch 价格一度被炒了上去，动森限定版更是翻了倍。可见其火热程度。</p>
<p>而我那时候也加入的动森大部队，并且加了群，大家在群里聊得热火朝天，各种摸，各种报价格，卖大头菜。那时候我就想着做一个“菜市场”小程序，方便大家卖大头菜。但等我开发出第一版的时候，卖大头菜的热度已经下去了，我就失去了开发的动力。后来在查动森信息的时候，无意间发现了 B 站的<a href="https://wiki.biligame.com/dongsen/%E9%A6%96%E9%A1%B5" target="_blank" rel="noopener">动森 WIKI 页</a>。于是我又转念一想，不如爬它数据做个图鉴吧！不过此时的心态完全是为了写爬虫练手，因为当时已经有很多成熟的图鉴app、小程序出现，我就不凑这个热闹了。</p>
<p>下面是小程序码，欢迎可以扫码体验。</p>
<p><img src="https://personal-1251959693.cos.ap-chengdu.myqcloud.com/2020-12-28-animalCrossingCode.jpg" alt></p>
<p>言归正传，下面是以<a href="https://wiki.biligame.com/dongsen/%E5%B0%8F%E5%8A%A8%E7%89%A9%E5%9B%BE%E9%89%B4" target="_blank" rel="noopener">动森小动物图鉴</a>页面为目标，写一个简易爬虫。</p>
<p>安装一些插件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># npm 初始化</span></span><br><span class="line">npm init -y</span><br><span class="line"><span class="comment"># 安装插件</span></span><br><span class="line">npm i superagent cheerio</span><br></pre></td></tr></table></figure>
<ul>
<li>superagent 是 node 环境下的 http 模块，可用来发器请求，稍后用来请求页面</li>
<li>cheerio 模块可以解析页面，然后可以使用与 jQuery 相同的语法来操作 DOM</li>
</ul>
<p>新建入口文件 <code>index.js</code></p>
<p>封装请求：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// getContent.js</span></span><br><span class="line"><span class="keyword">const</span> BASE_URL = <span class="string">'https://wiki.biligame.com'</span>;</span><br><span class="line"><span class="keyword">const</span> superagent = <span class="built_in">require</span>(<span class="string">"superagent"</span>);</span><br><span class="line"><span class="keyword">const</span> cheerio = <span class="built_in">require</span>(<span class="string">"cheerio"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取页面内容方法</span></span><br><span class="line"><span class="comment"> * @param &#123;String&#125; query 爬取的页面后缀</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getContent</span>(<span class="params">query</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    superagent.get(<span class="string">`<span class="subst">$&#123;BASE_URL&#125;</span>/dongsen/<span class="subst">$&#123;query&#125;</span>`</span>).end(<span class="function">(<span class="params">err, sres</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="keyword">return</span> reject(err)</span><br><span class="line">      &#125;</span><br><span class="line">      resolve(cheerio.load(sres.text));</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  getContent</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在编写爬取代码前我们要对页面做一个分析：</p>
<p>这是我们要爬取的目标页面</p>
<p><a href="https://wiki.biligame.com/dongsen/小动物图鉴" target="_blank" rel="noopener">https://wiki.biligame.com/dongsen/小动物图鉴</a></p>
<p>这是我们要爬取的目标</p>
<p><img src="https://personal-1251959693.cos.ap-chengdu.myqcloud.com/2020-12-28-141903.png" alt></p>
<p>每个小动物点击名字可进入详情页：</p>
<p><img src="/Users/tit1e/Library/Application Support/typora-user-images/image-20201228222202143.png" alt="image-20201228222202143"></p>
<p>可以看到详情页中信息比列表上的更为丰富，我们要想办法爬取详情页中的信息。所以需要去获取列表上 a 标签的地址，然后再去获取详情中的动物信息。</p>
<p>所以思路如下：</p>
<ol>
<li>首先请求列表页</li>
<li>获取列表中的所有小动物的项</li>
<li>循环项取出每项名字，获取名字上的a链接地址，拼接出完整路径</li>
<li>通过完整路径获取小动物的详细信息</li>
<li>写入数据</li>
</ol>
<p>思路清晰后那么开始编写代码，编辑 <code>index.js</code>：</p>
<p>首先我们要爬取所有小动物的数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 爬取小动物页面</span></span><br><span class="line"><span class="comment"> * @param &#123;Date&#125; update_time 爬虫执行时间，非必须</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; url 小动物页面的后缀</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getAnimals</span>(<span class="params">update_time, url</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> $ = <span class="keyword">await</span> getContent(url)</span><br><span class="line">  <span class="comment">// 获取列表中的所有项</span></span><br><span class="line">  <span class="keyword">const</span> nodes = $(<span class="string">"#CardSelectTr tbody tr"</span>)</span><br><span class="line">  <span class="comment">// 小动物详情页后缀，其实就是名字</span></span><br><span class="line">  <span class="keyword">const</span> animals = []</span><br><span class="line">  <span class="keyword">const</span> LENGTH = nodes.length</span><br><span class="line"> 	<span class="comment">// 第 0 项是表头，所以索引从 1 开始</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt; LENGTH; i++)&#123;</span><br><span class="line">    <span class="keyword">let</span> $element = $(nodes[i]);</span><br><span class="line">    <span class="comment">// 列表中有一项错误项，需要排除</span></span><br><span class="line">    <span class="keyword">if</span> ($element.find(<span class="string">'td'</span>).eq(<span class="number">0</span>).find(<span class="string">'a'</span>).text() !== <span class="string">'40pxString'</span>) &#123;</span><br><span class="line">      <span class="comment">// 获取小动物链接后缀</span></span><br><span class="line">      <span class="keyword">const</span> url = $element.find(<span class="string">'td'</span>).eq(<span class="number">0</span>).find(<span class="string">'a'</span>).attr(<span class="string">'href'</span>).substr(<span class="number">9</span>)</span><br><span class="line">      animals.push(url)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 删除 animals.txt，开始获取数据前，清除旧数据</span></span><br><span class="line">  fs.unlink(<span class="string">'animals.txt'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(error);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 为了按列表顺序获取小动物信息，我使用了递归</span></span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line">  getInfo(animals, index, animalInfo, update_time)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>getAnimals</code> 方法最后使用了 <code>getInfo</code> 递归函数，那么接下来编写 <code>getInfo</code>，依旧是在 <code>index.js</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"><span class="keyword">const</span> os = <span class="built_in">require</span>(<span class="string">"os"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getInfo</span>(<span class="params">list, index, func, update_time</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> name = list[index];</span><br><span class="line">  <span class="keyword">let</span> otherInfo = &#123;&#125;;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    otherInfo = <span class="keyword">await</span> func(name).catch(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (index &lt; list.length - <span class="number">1</span>) &#123;</span><br><span class="line">        index += <span class="number">1</span>;</span><br><span class="line">        getInfo(list, index, func, update_time);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="comment">// 出错跳过进入下一个小动物</span></span><br><span class="line">    <span class="keyword">if</span> (index &lt; list.length - <span class="number">1</span>) &#123;</span><br><span class="line">      index += <span class="number">1</span>;</span><br><span class="line">      getInfo(list, index, func, update_time);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// os.EOL 用于换行 http://nodejs.cn/api/os/os_eol.html</span></span><br><span class="line">  <span class="comment">// 获取到数据后写入 animals.txt</span></span><br><span class="line">  fs.appendFile(<span class="string">"animals.txt"</span>, <span class="built_in">JSON</span>.stringify(otherInfo) + os.EOL, (err) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">throw</span> err;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (index &lt; list.length - <span class="number">1</span>) &#123;</span><br><span class="line">        index += <span class="number">1</span>;</span><br><span class="line">        getInfo(list, index, func, update_time);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>递归方法也写好了，接下来就是真正获取小动物数据的方法，还是在 <code>index.js</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; getContent &#125; = <span class="built_in">require</span>(<span class="string">'./getContent.js'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取小动物信息</span></span><br><span class="line"><span class="comment"> * @param &#123;String&#125; url 小动物页面后缀</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">animalInfo</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="keyword">async</span> (resolve, reject) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> $ = <span class="keyword">await</span> getContent(url).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        reject()</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="comment">// 定义小动物各项信息的字段</span></span><br><span class="line">      <span class="keyword">const</span> list = [<span class="string">'birthday'</span>, <span class="string">'character'</span>, <span class="string">'mantra'</span>, <span class="string">'hobby'</span>, <span class="string">'style'</span>, <span class="string">'color'</span>, <span class="string">'vioce'</span>, <span class="string">'ethnicity'</span>, <span class="string">'motto'</span>, <span class="string">'foreign_name'</span>]</span><br><span class="line">      <span class="keyword">const</span> nodes = $(<span class="string">".box-poke-left .box-poke"</span>)</span><br><span class="line">      <span class="keyword">const</span> str = $(<span class="string">".box-poke-left .box-title-1"</span>).text()</span><br><span class="line">      <span class="keyword">const</span> name = str.substr(<span class="number">0</span>, str.length <span class="number">-1</span>)</span><br><span class="line">      <span class="keyword">const</span> sex = str.substr(<span class="number">-1</span>) === <span class="string">'♂'</span> ? <span class="string">'男'</span> : <span class="string">'女'</span></span><br><span class="line">      <span class="keyword">const</span> image = $(<span class="string">".box-poke-right"</span>).find(<span class="string">'img'</span>).attr(<span class="string">'src'</span>)</span><br><span class="line">      <span class="keyword">const</span> info = &#123;</span><br><span class="line">        name,</span><br><span class="line">        sex,</span><br><span class="line">        image,</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; list.length; i++)&#123;</span><br><span class="line">        <span class="keyword">const</span> attr = list[i]</span><br><span class="line">        <span class="keyword">const</span> text = nodes.eq(i).find(<span class="string">'.box-font'</span>).text()</span><br><span class="line">        <span class="keyword">if</span> (attr === <span class="string">'birthday'</span>) &#123;</span><br><span class="line">          <span class="comment">// 处理小动物的信息，也可以不处理</span></span><br><span class="line">          info[attr] = text.replace(<span class="string">'月'</span>, <span class="string">'-'</span>).replace(<span class="string">'日'</span>, <span class="string">''</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          info[attr] = text</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      info.birth_month = info.birthday.split(<span class="string">'-'</span>).shift()</span><br><span class="line">      resolve(info)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      reject(url + <span class="string">'出错啦'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，在 <code>index.js</code> 最后执行方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> now = <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line"><span class="keyword">const</span> query = <span class="built_in">encodeURIComponent</span>(<span class="string">'小动物图鉴'</span>)</span><br><span class="line">getAnimals(now, query)</span><br></pre></td></tr></table></figure>
<p>完整的 <code>index.js</code> ：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"><span class="keyword">const</span> os = <span class="built_in">require</span>(<span class="string">"os"</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; getContent &#125; = <span class="built_in">require</span>(<span class="string">'./getContent.js'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getInfo</span>(<span class="params">list, index, func, update_time</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> name = list[index];</span><br><span class="line">  <span class="keyword">let</span> otherInfo = &#123;&#125;;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    otherInfo = <span class="keyword">await</span> func(name).catch(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (index &lt; list.length - <span class="number">1</span>) &#123;</span><br><span class="line">        index += <span class="number">1</span>;</span><br><span class="line">        getInfo(list, index, func, update_time);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="comment">// 出错跳过进入下一个小动物</span></span><br><span class="line">    <span class="keyword">if</span> (index &lt; list.length - <span class="number">1</span>) &#123;</span><br><span class="line">      index += <span class="number">1</span>;</span><br><span class="line">      getInfo(list, index, func, update_time);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// os.EOL 用于换行 http://nodejs.cn/api/os/os_eol.html</span></span><br><span class="line">  fs.appendFile(<span class="string">"animals.txt"</span>, <span class="built_in">JSON</span>.stringify(otherInfo) + os.EOL, (err) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">throw</span> err;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (index &lt; list.length - <span class="number">1</span>) &#123;</span><br><span class="line">        index += <span class="number">1</span>;</span><br><span class="line">        getInfo(list, index, func, update_time);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取小动物信息</span></span><br><span class="line"><span class="comment"> * @param &#123;String&#125; url 小动物页面后缀</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">animalInfo</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="keyword">async</span> (resolve, reject) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> $ = <span class="keyword">await</span> getContent(url).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        reject()</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="keyword">const</span> list = [<span class="string">'birthday'</span>, <span class="string">'character'</span>, <span class="string">'mantra'</span>, <span class="string">'hobby'</span>, <span class="string">'style'</span>, <span class="string">'color'</span>, <span class="string">'vioce'</span>, <span class="string">'ethnicity'</span>, <span class="string">'motto'</span>, <span class="string">'foreign_name'</span>]</span><br><span class="line">      <span class="keyword">const</span> nodes = $(<span class="string">".box-poke-left .box-poke"</span>)</span><br><span class="line">      <span class="keyword">const</span> str = $(<span class="string">".box-poke-left .box-title-1"</span>).text()</span><br><span class="line">      <span class="keyword">const</span> name = str.substr(<span class="number">0</span>, str.length <span class="number">-1</span>)</span><br><span class="line">      <span class="keyword">const</span> sex = str.substr(<span class="number">-1</span>) === <span class="string">'♂'</span> ? <span class="string">'男'</span> : <span class="string">'女'</span></span><br><span class="line">      <span class="keyword">const</span> image = $(<span class="string">".box-poke-right"</span>).find(<span class="string">'img'</span>).attr(<span class="string">'src'</span>)</span><br><span class="line">      <span class="keyword">const</span> info = &#123;</span><br><span class="line">        name,</span><br><span class="line">        sex,</span><br><span class="line">        image,</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; list.length; i++)&#123;</span><br><span class="line">        <span class="keyword">const</span> attr = list[i]</span><br><span class="line">        <span class="keyword">const</span> text = nodes.eq(i).find(<span class="string">'.box-font'</span>).text()</span><br><span class="line">        <span class="keyword">if</span> (attr === <span class="string">'birthday'</span>) &#123;</span><br><span class="line">          info[attr] = text.replace(<span class="string">'月'</span>, <span class="string">'-'</span>).replace(<span class="string">'日'</span>, <span class="string">''</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          info[attr] = text</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      info.birth_month = info.birthday.split(<span class="string">'-'</span>).shift()</span><br><span class="line">      resolve(info)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      reject(url + <span class="string">'出错啦'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 爬取小动物页面</span></span><br><span class="line"><span class="comment"> * @param &#123;Date&#125; update_time 爬虫执行时间，非必须</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; url 小动物页面的后缀</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getAnimals</span>(<span class="params">update_time, url</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> $ = <span class="keyword">await</span> getContent(url)</span><br><span class="line">  <span class="keyword">const</span> nodes = $(<span class="string">"#CardSelectTr tbody tr"</span>)</span><br><span class="line">  <span class="keyword">const</span> animals = []</span><br><span class="line">  <span class="keyword">const</span> LENGTH = nodes.length</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt; LENGTH; i++)&#123;</span><br><span class="line">    <span class="keyword">let</span> $element = $(nodes[i]);</span><br><span class="line">    <span class="keyword">if</span> ($element.find(<span class="string">'td'</span>).eq(<span class="number">0</span>).find(<span class="string">'a'</span>).text() !== <span class="string">'40pxString'</span>) &#123;</span><br><span class="line">      <span class="comment">// 获取小动物链接后缀</span></span><br><span class="line">      <span class="keyword">const</span> url = $element.find(<span class="string">'td'</span>).eq(<span class="number">0</span>).find(<span class="string">'a'</span>).attr(<span class="string">'href'</span>).substr(<span class="number">9</span>)</span><br><span class="line">      animals.push(url)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 删除 animals.txt，开始获取数据前，清除旧数据</span></span><br><span class="line">  fs.unlink(<span class="string">'animals.txt'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(error);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 递归获取信息</span></span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line">  getInfo(animals, index, animalInfo, update_time)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 我们爬取的页面是 https://wiki.biligame.com/dongsen/%E5%B0%8F%E5%8A%A8%E7%89%A9%E5%9B%BE%E9%89%B4</span></span><br><span class="line"><span class="keyword">const</span> now = <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line"><span class="keyword">const</span> query = <span class="built_in">encodeURIComponent</span>(<span class="string">'小动物图鉴'</span>)</span><br><span class="line">getAnimals(now, query)</span><br></pre></td></tr></table></figure>
<p>运行爬虫：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node index.js</span><br></pre></td></tr></table></figure>
<p>不出意外会在根目录下生成一个 animals.txt 文件。</p>
<p><img src="https://personal-1251959693.cos.ap-chengdu.myqcloud.com/2020-12-28-145321.png" alt></p>
<p><a href="https://github.com/Tit1e/Demos/tree/master/142.node-spider">源码查看</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2020/12/24/141-pm2/" class="next">下一篇</a></div><div class="copyright"><p>© 2016 - 2020 <a href="https://github.com/Tit1e" target="_blank">Tit1e</a>, powered by <a href="https://github.com/Tit1e/hexo-theme-simple" target="_blank">hexo-theme-simple</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>