<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>js 上传文件至腾讯云对象存储 · Tit1e</title><meta name="description" content="js 上传文件至腾讯云对象存储 - Tit1e"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://github.com/Tit1e/atom.xml" title="Tit1e"></head><body><div class="wrap"><header><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">主页</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">过往</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">订阅</a></li><li class="nav-list-item"><a href="https://album.animalcrossing.life" target="_blank" class="nav-list-link">关于</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">js 上传文件至腾讯云对象存储</h1><div class="post-info">Dec 19, 2020</div><div class="post-content"><p>今天终于把自己的摄影展示网站发布到了线上。<a href="https://album.animalcrossing.life" target="_blank" rel="noopener">查看网站</a></p>
<p>这个网站整体并不复杂，但是其中也有不少值得记录的难点，比如从前端上传文件至腾讯云的对象存储，公司业务中我使用过七牛的云存储，腾讯的还从未接触过。本以为应该跟七牛的差不多，但没想到我费了好大的力气各种看文档、看别人的博客才成功上传。</p>
<p>吐槽一句腾讯的文档写的真的好差。</p>
<p>下面分享一下我的上传配置及流程：</p>
<p>整个流程需要前端和后端的配合，所以代码会分为前端代码与后端代码两个部分，下面我会注明。后端我用的是 Node.js。</p>
<h2 id="上传流程说明"><a href="#上传流程说明" class="headerlink" title="上传流程说明"></a>上传流程说明</h2><p>上传的整体流程大概是这样：</p>
<p>1、上传前，前端发起请求向服务器发起请求获取上传的临时密钥</p>
<p>2、服务器端收到请求，通过腾讯官方的 sdk 计算出临时密钥并返回给前端</p>
<p>3、前端获取到临时密钥，获取选择的文件，计算 md5 值作为文件名（这样相同文件就不会重复上传）</p>
<p>4、通过官方的 sdk 进行上传，在回调中处理上传后的逻辑</p>
<p>##后端代码 Node.js</p>
<p>基础的服务运行环境我就不做展开了，只讲获取临时密钥的过程。</p>
<p>首先需要安装 qcloud-cos-sts 依赖：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install qcloud-cos-sts --save</span><br></pre></td></tr></table></figure>
<p>然后就是在你请求的方法文件中编写代码，个人视不同请求而定：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这是我的文件 upload.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入依赖</span></span><br><span class="line"><span class="keyword">const</span> STS = <span class="built_in">require</span>(<span class="string">'qcloud-cos-sts'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义配置项</span></span><br><span class="line"><span class="comment">// 密钥可从腾讯云控制台的【API密钥管理】中获取：https://console.cloud.tencent.com/cam/capi</span></span><br><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">  secretId: <span class="string">'你的固定密钥'</span>, <span class="comment">// 替换你的固定密钥</span></span><br><span class="line">  secretKey: <span class="string">'你的固定密钥'</span>, <span class="comment">// 替换你的固定密钥</span></span><br><span class="line">  proxy: <span class="string">''</span>,</span><br><span class="line">  durationSeconds: <span class="number">6000</span>, <span class="comment">// 密钥有效期</span></span><br><span class="line">  <span class="comment">// 放行判断相关参数</span></span><br><span class="line">  bucket: <span class="string">'bucket名字'</span>, <span class="comment">// 换成你的 bucket</span></span><br><span class="line">  region: <span class="string">'bucket 地区'</span>, <span class="comment">// 换成 bucket 所在地区</span></span><br><span class="line">  allowPrefix: <span class="string">'*'</span>, <span class="comment">// 这里改成允许的路径前缀，可以根据自己网站的用户登录态判断允许上传的具体路径，例子： a.jpg 或者 a/* 或者 * (使用通配符*存在重大安全风险, 请谨慎评估使用)</span></span><br><span class="line">  allowActions: [</span><br><span class="line">    <span class="comment">// 所有 action 请看文档 https://cloud.tencent.com/document/product/436/31923</span></span><br><span class="line">    <span class="comment">// 简单上传</span></span><br><span class="line">    <span class="string">'name/cos:PutObject'</span>,</span><br><span class="line">    <span class="string">'name/cos:PostObject'</span>,</span><br><span class="line">    <span class="comment">// 分片上传</span></span><br><span class="line">    <span class="string">'name/cos:sliceUploadFile'</span>,</span><br><span class="line">    <span class="string">'name/cos:InitiateMultipartUpload'</span>,</span><br><span class="line">    <span class="string">'name/cos:ListMultipartUploads'</span>,</span><br><span class="line">    <span class="string">'name/cos:ListParts'</span>,</span><br><span class="line">    <span class="string">'name/cos:UploadPart'</span>,</span><br><span class="line">    <span class="string">'name/cos:CompleteMultipartUpload'</span>,</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 我用的是express，所以接口方法这样写，最外层的方法无所谓，每个人都不一样，主要是里面的内容</span></span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/upload/sts'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 获取临时密钥</span></span><br><span class="line">  <span class="keyword">const</span> shortBucketName = config.bucket.substr(<span class="number">0</span>, config.bucket.lastIndexOf(<span class="string">'-'</span>));</span><br><span class="line">  <span class="keyword">const</span> appId = config.bucket.substr(<span class="number">1</span> + config.bucket.lastIndexOf(<span class="string">'-'</span>));</span><br><span class="line">  <span class="keyword">const</span> policy = &#123;</span><br><span class="line">    version: <span class="string">'2.0'</span>,</span><br><span class="line">    statement: [&#123;</span><br><span class="line">      action: config.allowActions,</span><br><span class="line">      effect: <span class="string">'allow'</span>,</span><br><span class="line">      principal: &#123; <span class="attr">qcs</span>: [<span class="string">'*'</span>] &#125;,</span><br><span class="line">      resource: [</span><br><span class="line">        <span class="string">`qcs::cos:<span class="subst">$&#123;config.region&#125;</span>:uid/<span class="subst">$&#123;appId&#125;</span>:prefix//<span class="subst">$&#123;appId&#125;</span>/<span class="subst">$&#123;shortBucketName&#125;</span>/<span class="subst">$&#123;config.allowPrefix&#125;</span>`</span>,</span><br><span class="line">      ],</span><br><span class="line">    &#125;],</span><br><span class="line">  &#125;;</span><br><span class="line">  STS.getCredential(&#123;</span><br><span class="line">    secretId: config.secretId,</span><br><span class="line">    secretKey: config.secretKey,</span><br><span class="line">    proxy: config.proxy,</span><br><span class="line">    durationSeconds: config.durationSeconds,</span><br><span class="line">    policy,</span><br><span class="line">  &#125;, (err, tempKeys) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> result = err || tempKeys || <span class="string">''</span>;</span><br><span class="line">    res.json(<span class="keyword">new</span> Result(&#123; <span class="attr">data</span>: result &#125;));</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>存储桶的相关信息可以在控制台的存储桶的【概览】中查看。</p>
<p>注意：<strong>存储桶所在地域只需括号中的内容，不需要中文</strong>。</p>
<p><img src="https://personal-1251959693.cos.ap-chengdu.myqcloud.com/2020-12-19-153605.png" alt></p>
<p>后端计算临时密钥的方法就是以上这些了。</p>
<h2 id="前端代码"><a href="#前端代码" class="headerlink" title="前端代码"></a>前端代码</h2><p>在配置文件中定义好基础信息</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @/utils/cosConf.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  Bucket: <span class="string">''</span>, <span class="comment">// Bucket 名称</span></span><br><span class="line">  Region: <span class="string">''</span>, <span class="comment">// Bucket 地域</span></span><br><span class="line">  Domain: <span class="string">''</span>, <span class="comment">// Bucket 访问域名</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>然后安装以下依赖</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install cos-js-sdk-v5 spark-md5 --save</span><br></pre></td></tr></table></figure>
<p>具体上传代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> COS <span class="keyword">from</span> <span class="string">'cos-js-sdk-v5'</span>;</span><br><span class="line"><span class="keyword">import</span> SparkMD5 <span class="keyword">from</span> <span class="string">'spark-md5'</span>;</span><br><span class="line"><span class="comment">// 这个方法是文章中上面写的获取临时密钥的请求方法</span></span><br><span class="line"><span class="keyword">import</span> &#123; sts &#125; <span class="keyword">from</span> <span class="string">'@/api/upload'</span>;</span><br><span class="line"><span class="comment">// 上面定义的基础信息</span></span><br><span class="line"><span class="keyword">import</span> cosConfig <span class="keyword">from</span> <span class="string">'./cosConf'</span>;</span><br><span class="line"><span class="keyword">let</span> key = <span class="string">''</span>;</span><br><span class="line"><span class="comment">// 配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化实例</span></span><br><span class="line"><span class="keyword">const</span> cos = <span class="keyword">new</span> COS(&#123;</span><br><span class="line">  <span class="keyword">async</span> getAuthorization(options, callback) &#123;</span><br><span class="line">    <span class="comment">// 获取临时密钥</span></span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> sts();</span><br><span class="line">    <span class="keyword">const</span> authdata = res.data;</span><br><span class="line">    <span class="keyword">const</span> auth = &#123;</span><br><span class="line">      TmpSecretId: authdata.credentials.tmpSecretId,</span><br><span class="line">      TmpSecretKey: authdata.credentials.tmpSecretKey,</span><br><span class="line">      XCosSecurityToken: authdata.credentials.sessionToken,</span><br><span class="line">      ExpiredTime: authdata.expiredTime, <span class="comment">// 在ExpiredTime时间前，不会再次调用getAuthorization</span></span><br><span class="line">    &#125;;</span><br><span class="line">    callback(auth);</span><br><span class="line">  &#125;,</span><br><span class="line">  FileParallelLimit: <span class="number">3</span>, <span class="comment">// 文件并发数</span></span><br><span class="line">  ChunkParallelLimit: <span class="number">8</span>, <span class="comment">// 同一个上传文件的分块并发数</span></span><br><span class="line">  ChunkSize: <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">8</span>, <span class="comment">// 分块上传时，每块的字节数大小</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得文件md5</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFileMD5</span>(<span class="params">file, callback</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 声明必要的变量</span></span><br><span class="line">  <span class="keyword">const</span> fileReader = <span class="keyword">new</span> FileReader();</span><br><span class="line">  <span class="comment">// 文件每块分割2M，计算分割详情</span></span><br><span class="line">  <span class="keyword">const</span> chunkSize = <span class="number">2</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line">  <span class="keyword">const</span> chunks = <span class="built_in">Math</span>.ceil(file.size / chunkSize);</span><br><span class="line">  <span class="keyword">let</span> currentChunk = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建md5对象（基于SparkMD5）</span></span><br><span class="line">  <span class="keyword">const</span> spark = <span class="keyword">new</span> SparkMD5();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 每块文件读取完毕之后的处理</span></span><br><span class="line">  fileReader.onload = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 每块交由sparkMD5进行计算</span></span><br><span class="line">    spark.appendBinary(e.target.result);</span><br><span class="line">    currentChunk += <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果文件处理完成计算MD5，如果还有分片继续处理</span></span><br><span class="line">    <span class="keyword">if</span> (currentChunk &lt; chunks) &#123;</span><br><span class="line">      <span class="comment">// eslint-disable-next-line no-use-before-define</span></span><br><span class="line">      loadNext();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      callback(spark.end());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理单片文件的上传</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">loadNext</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> start = currentChunk * chunkSize;</span><br><span class="line">    <span class="keyword">const</span> end = start + chunkSize &gt;= file.size ? file.size : start + chunkSize;</span><br><span class="line"></span><br><span class="line">    fileReader.readAsBinaryString(file.slice(start, end));</span><br><span class="line">  &#125;</span><br><span class="line">  loadNext();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 小文件直接上传-通过putObject上传</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">uploadFile</span>(<span class="params">file, callback, progressBc</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 得到md5码</span></span><br><span class="line">  getFileMD5(file, (md5) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 存储文件的md5码</span></span><br><span class="line">    file.md5 = md5;</span><br><span class="line">    <span class="keyword">const</span> subfix = file.name.substr(file.name.lastIndexOf(<span class="string">'.'</span>));</span><br><span class="line">    key = process.env.VUE_APP_BUCKET_PATH + file.md5 + subfix;</span><br><span class="line">    cos.putObject(&#123;</span><br><span class="line">      Bucket: cosConfig.Bucket,</span><br><span class="line">      Region: cosConfig.Region,</span><br><span class="line">      Key: key,</span><br><span class="line">      Body: file,</span><br><span class="line">      onProgress(progressData) &#123;</span><br><span class="line">        <span class="comment">// 上传进度</span></span><br><span class="line">        progressBc(progressData.percent);</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;, (err, data) =&gt; &#123;</span><br><span class="line">      <span class="comment">// 成功或出错回调</span></span><br><span class="line">      callback(err, data);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 大文件分片上传-通过sliceUploadFile上传</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">uploadFile2</span>(<span class="params">file, callback, progressBc</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 得到md5码</span></span><br><span class="line">  getFileMD5(file, (md5) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 存储文件的md5码</span></span><br><span class="line">    file.md5 = md5;</span><br><span class="line">    <span class="keyword">const</span> subfix = file.name.substr(file.name.lastIndexOf(<span class="string">'.'</span>));</span><br><span class="line">    key = process.env.VUE_APP_BUCKET_PATH + file.md5 + subfix;</span><br><span class="line">    cos.sliceUploadFile(&#123;</span><br><span class="line">      Bucket: cosConfig.Bucket,</span><br><span class="line">      Region: cosConfig.Region,</span><br><span class="line">      Key: key,</span><br><span class="line">      Body: file,</span><br><span class="line">      onProgress(progressData) &#123;</span><br><span class="line">        <span class="comment">// 上传进度</span></span><br><span class="line">        progressBc(progressData.percent);</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;, (err, data) =&gt; &#123;</span><br><span class="line">      callback(err, data);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用上传的话，只需这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;input type=&quot;file&quot; accept=&quot;image/*&quot; ref=&quot;upload&quot; id=&quot;upload&quot;&gt;</span><br><span class="line">    &lt;button @click=&quot;submit&quot;&gt;上 传&lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">	import &#123; uploadFile &#125; from &apos;@/utils/uploadfile&apos;;</span><br><span class="line">  export default &#123;</span><br><span class="line">    methods: &#123;</span><br><span class="line">      submit()&#123;</span><br><span class="line">        const file = this.$refs.upload.files[0]</span><br><span class="line">        uploadFile(file, (err, data) =&gt; &#123;</span><br><span class="line">            // 回调</span><br><span class="line">            if(!err)&#123;</span><br><span class="line">              // 上传成功处理</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">              // 出错处理</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;, progress =&gt; &#123;</span><br><span class="line">            // 这里可以设置上传进度</span><br><span class="line">          &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h2 id="存储桶设置"><a href="#存储桶设置" class="headerlink" title="存储桶设置"></a>存储桶设置</h2><p>最后，存储桶还需要设置跨域访问，否则哪怕前面都正确，文件也无法上传。</p>
<p>在存储桶的【安全管理】-【跨域访问CORS设置】中添加规则，设置域名白名单，保存生效后，不出意外就可以正常上传文件了。</p>
<p><img src="https://personal-1251959693.cos.ap-chengdu.myqcloud.com/2020-12-19-155231.png" alt></p>
</div></article></div></main><footer><div class="paginator"><a href="/2020/12/17/138-ios-desktop/" class="next">下一篇</a></div><div class="copyright"><p>© 2016 - 2020 <a href="https://github.com/Tit1e" target="_blank">Tit1e</a>, powered by <a href="https://github.com/Tit1e/hexo-theme-simple" target="_blank">hexo-theme-simple</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>